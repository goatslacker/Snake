<script type="text/javascript" src="prototype.js"></script>
<script type="text/javascript" src="snake.js"></script>
<script type="text/javascript" src="stemmer.js"></script>
<script type="text/javascript" src="dreamcatcher.js"></script>

<script type="text/javascript">

  function performSearches () {
    doTestSearch("two words"); // Doesn't return proper results .
    // we need to combine the words and single them out as well? combined words work in quotes?
    // not a Snake error necessarily -
    doTestSearch("nonsense"); // Ok
    doTestSearch("hello world"); // Ok
    doTestSearch("abc"); // Ok
    doTestSearch("school"); // Ok
    doTestSearch("commando"); // Ok
    doTestSearch("Ratproof"); // Ok
  }

  function doTestSearch (str) {
    var words = str.split(" ")
      , stemmed_words = []
      , i = 0
      , query = "",
      q = [];
    
    for (i = 0; i < words.length; i = i + 1) {
      stemmed_words.push(stemmer(words[i].replace(/[^a-zA-Z 0-9]+/g,'')));
      q.push("?");
    }

    // custom query
    query = "SELECT dream_id, COUNT(*) AS nb, SUM(weight) AS total_weight, dream.id, dream.title, dream.summary, dream.dream_date, dream.created_at FROM dream_search, dream WHERE dream_id = dream.id AND stem IN (#{words}) GROUP BY dream_id ORDER BY nb DESC, total_weight DESC".interpolate({ words: q });

    // hydrates a record set
    Snake.query(query, stemmed_words, Snake.hydrateRS.bind(this, DreamPeer, function (dreams) {
      console.log(dreams);
    }));

    // FIXME we'll need getters and setters for tags for example...tags are in a different db and I won't always be joining!
  }

  function updateSearchIndex (dream) {
    dream = dream || new Dream();

    dream.title = dream.title || "";
    dream.summary = dream.summary || "";

    // get keywords and push them into an array repeated by weight...
    var summary = dream.summary.split(" ")
      , title = dream.title.split(" ")
      , tags = dream.tags
      , keywords = []
      , stop = [
        'i', 'im', 'ive', 'me', 'my', 'myself', 'we', 'weve', 'our', 'ours', 'ourselves', 'you', 'your', 
        'youre', 'youve', 'yours', 'yourself', 'yourselves', 'he', 'hes', 'hay', 'hey', 'him', 'his', 'himself', 'she', 
        'her', 'hers', 'herself', 'it', 'its', 'itself', 'they', 'them', 'their', 'theirs', 'themselves', 'didnt',
        'can', 'cent', 'what', 'which', 'who', 'whom', 'this', 'that', 'these', 'those', 'am', 'is', 'are', 'los',
        'was', 'take', 'aint', 'were', 'be', 'been', 'being', 'have', 'has', 'had', 'having', 'do', 'does',
        'did', 'cause', 'doing', 'a', 'an', 'the', 'and', 'but', 'if', 'or', 'because', 'as', 'until', 'will',
        'while', 'of', 'hi', 'at', 'by', 'for', 'with', 'about', 'against', 'between', 'into', 'makes', 'cannot',
        'through', 'during', 'before', 'after', 'above', 'below', 'to', 'from', 'up', 'down', 'else', 'ever',
        'in', 'out', 'on', 'off', 'over', 'under', 'again', 'further', 'then', 'once', 'here', 'ago', 'give',
        'there', 'when', 'where', 'why', 'how', 'all', 'any', 'both', 'each', 'few', 'more', 'find', 'goes',
        'most', 'other', 'some', 'such', 'no', 'nor', 'not', 'only', 'own', 'same', 'so', 'must', 'wed',
        'than', 'too', 'very', 'put', 'also', 'other', 'gave', 'well', 'know', 'make', 'seen', 'shes',
        'let', ''
      ]
      , no_push = false
      , keys = []
      , keyword = null
      , index = {}
      , i = 0
      , j = 0
      , n = []
      , c = null;

    // delete existing keywords
    c = new Snake.Criteria();
    c.add(DreamSearchPeer.DREAM_ID, dream.id);
    DreamSearchPeer.doDelete(c);

    // remove stop words

    // then remove all the stop words
    // and remove all special chars, stem the words

    for (i = 0; i < summary.length; i = i + 1) {
      keyword = summary[i].replace(/[^a-zA-Z 0-9]+/g,'');

      for (j = 0; j < stop.length; j = j + 1) {
        if (stop[j] === keyword.toLowerCase()) {
          no_push = true;
        }
      }

      if (!no_push) {
        n.push(keyword);
      }

      no_push = false;
    }

    keywords = title.concat(title, title, n, tags, tags, tags)

    for (i = 0; i < keywords.length; i = i + 1) {
      if (keywords[i] && keywords[i].length >= 3) {
        // remove special chars, stem and push into keys
        var no_special_chars = keywords[i].replace(/[^a-zA-Z 0-9]+/g,'')
          , stemmed = stemmer(no_special_chars).toLowerCase();

        index[stemmed] = no_special_chars;
        keys.push(stemmed);
      }
    }

    keys.sort();

    keywords = {};

    // add up the weights

    for (i = 0; i < keys.length; i = i + 1) {
      if (i > 0 && keys[i] === keys[i - 1]) {
        keywords[keys[i]]++;
      } else {
        keywords[keys[i]] = 1;
      }
    }

    // add to database!
    for (i in keywords) {
      if (keywords.hasOwnProperty(i)) {
        var ds = new DreamSearch();
        ds.dream_id = dream.id;
        ds.word = index[i]; 
        ds.stem = i;
        ds.weight = keywords[i];
        ds.save();
      }
    }
  }


  function loadViaLoop () {
    var dreams = [
      {
        title: "Hello World",
        dream: "But I must explain to you how all this mistaken idea of denouncing pleasure and praising pain was born and I will give you a complete account of the system, and expound the actual teachings of the great explorer of the truth, the master-builder of human happiness. No one rejects, dislikes, or avoids pleasure itself, because it is pleasure, but because those who do not know how to pursue pleasure rationally encounter consequences that are extremely painful. Nor again is there anyone who loves or pursues or desires to obtain pain of itself, because it is pain, but because occasionally circumstances occur in which toil and pain can procure him some great pleasure. To take a trivial example, which of us ever undertakes laborious physical exercise, except to obtain some advantage from it? But who has any right to find fault with a man who chooses to enjoy a pleasure that has no annoying consequences, or one who avoids a pain that produces no resultant pleasure? On the other hand, we denounce with righteous indignation and dislike men who are so beguiled and demoralized by the charms of pleasure of the moment, so blinded by desire, that they cannot foresee",
        date_format: "12-19-2010",
        timestamp: null,
        tags: []
      },
      {
        title: "List of funky characters",
        dream: "abc def ghi jkl mno pqrs tuv wxyz ABC DEF GHI JKL MNO PQRS TUV WXYZ ! \"§ $%& /() =? * '<> |; ²³~ @`´ ©«» ¤¼× {} abc def ghi jkl mno pqrs tuv wxyz ABC DEF GHI JKL MNO PQRS TUV WXYZ ! \"§ $%& /() =? * '<> |; ²³~ @`´ ©«» ¤¼× {} abc def ghi jkl mno pqrs tuv wxyz ABC DEF GHI JKL MNO PQRS TUV WXYZ ! \"§ $%& /() =? * '<> |; ²³~ @`´ ©«» ¤¼× {} abc def ghi jkl mno pqrs tuv wxyz ABC DEF GHI JKL MNO PQRS TUV WXYZ ! \"§ $%& /() =? * '<> |; ²³~ @`´ ©«» ¤¼× {} abc def ghi jkl mno pqrs tuv wxyz ABC DEF GHI JKL MNO PQRS TUV WXYZ ! \"§ $%& /() =? * '<> |; ²³~ @`´ ©«» ¤¼× {} abc def ghi jkl mno pqrs tuv wxyz ABC DEF GHI JKL MNO PQRS TUV WXYZ ! \"§ $%& /() =? * '<> |; ²³~ @`´ ©«» ¤¼× {} abc def ghi jkl mno pqrs tuv wxyz ABC DEF GHI JKL MNO PQRS TUV WXYZ ! \"§ $%& /() =? * '<> |; ²³~ @`´ ©«» ¤¼× {}abc def ghi jkl mno pqrs tuv wxyz ABC DEF GHI",
        date_format: "12-30-2010",
        timestamp: null,
        tags: ["abc"]
      },
      {
        title: "Nonsense",
        dream: "Bridger ramed replace, lace bredi keerie gab ophiomorph. On, a seep, mops, bebrine, musettes us dad, loups. Swallow ebb fir, if blob, fluvio, eats squalene a a radial, denned. Drib tiens till, jailers websterian dewier, kamiks fro refered a non suppressor, rimose, a vic, ell flintworker, fohat dew nonpurgative. Coelostat redischarge mealock disrates annas, underskin stockrooms oh ha, poll, ha, hat gem, choel, cilioretinal. Debugged, fuss fort, a found nondocumental, nabs gorgon gap releasor, is, in, iso. Leaf preaccommodated ow unshowable, toed, lei alumroots to bird maladaptive metanotum, viperous ant jest kagus, conceiver, be tv goloe, nonlibelous. Ammos furl, plumpened. If unearned, to kcal. Microlith anorectic, carib, perau, a bred microcranous jut. Nasat, fed off, whisks, acenaphthene, on, piasaba archons dangersome, jeans. Ratproof pomonic, undertie, an, uh. Francia desisted, ow sons joie brad, moll toil put doh, kit. It mandil, encarditis, misreport. Classicists creophagous, file, bub, evechurr, wilga multipass, craftless, cop. Disk bieberite memorial moil, impendence, a jail goes pupigerous, acorus a insultation a sled. Fig, son, sputa a frisk, subgum gin, wit, wed mesa. Letting, amuck reinventing, a orchidaceous. If sat, as testaceous, vat begirt, premeasured. Scrab, uh, is, rocker hirling, dike albacea, staff, us bale. Sampan, latter, palar, serrulateed, gimp windsorite, dorms, asp lour rimbase. Glassblowing frier ok, weld, a udometers, ass iso, unbare. Draw a unaffectation age prereckoning, nain, a den, cutup durns two bairns lonesome, pawkrie, sunlet, adversion phew in. Coble, leerfish phonesis, mace briar, micrometeorograph, unopressible a bum droghlin car, overlander. Duds runtish, cafe, died. Drawn, ren curemaster, governail be calci, meatworks, seen. Hairs gag rep, be vat on, semihardness khodja nave. Rowboats, a or misdrives coos, dings, upleg, of, flickering an, deathroot. Kith on, biological, egg. Uh, dildoe sertive muskies, lurers, donative uh, talite, orb reg. Uptowns hive, ribs, um lollapaloosa a asphalt, noduli.",
        date_format: "11-15-2010",
        timestamp: null,
        tags: ["bridger", "flintworker", "undertie", "biological"]
      },
      {
        title: "Time in school",
        dream: "I never spend much time in school but I taught ladies plenty. It's true I hire my body out for pay, hey hey. I've gotten burned over Cheryl Tiegs, blown up for Raquel Welch. But when I end up in the hay it's only hay, hey hey. I might jump an open drawbridge, or Tarzan from a vine. 'Cause I'm the unknown stuntman that makes Eastwood look so fine.",
        date_format: "09-09-2009",
        timestamp: 1293581218811,
        tags: ['school', 'vine', 'Eastwood', 'Tarzan', 'ladies']
      },
      {
        title: 'My "job"',
        dream: "This is my boss, Jonathan Hart, a self-made millionaire, he's quite a guy. This is Mrs H., she's gorgeous, she's one lady who knows how to take care of herself. By the way, my name is Max. I take care of both of them, which ain't easy, 'cause when they met it was MURDER!",
        date_format: "07-07-2007",
        timestamp: null,
        tags: ['boss,guy,gorgeous,lady,max']
      },
      {
        title: "The Who",
        dream: "Ten years ago a crack commando unit was sent to prison by a military court for a crime they didn't commit. These men promptly escaped from a maximum security stockade to the Los Angeles underground. Today, still wanted by the government, they survive as soldiers of fortune. If you have a problem and no one else can help, and if you can find them, maybe you can hire the A-team.",
        date_format: "10-10-2010",
        timestamp: null,
        tags: ['crack,', 'commando,', 'unit,', 'prison,', 'escaped', 'two words']
      },
    ];

    var dream = null;

    for (var i = 0; i < dreams.length; i = i + 1) {
      dream = new Dream();
      dream.title = dreams[i].title;
      dream.summary = dreams[i].dream;
      dream.dream_date = dreams[i].date_format;
      dream.created_at = dreams[i].timestamp;

      dream.save((function (i, model) {
        if (dreams[i].tags.length > 0) {

          var tags = [];

          for (var j = 0; j < dreams[i].tags.length; j = j + 1) {
            var tag = new DreamTag();
            tag.dream_id = model.id;
            tag.tag = dreams[i].tags[j].replace(/[^a-zA-Z 0-9]+/g,'');
            tag.normalized = tag.tag.toLowerCase().split(" ").join("-");

            tag.save();
            tags.push(tag.tag);
          }

          model.tags = tags;
        }

        updateSearchIndex(model); 
      }).bind(this, i));
    }

  }

  function insert () {
    var dream = new Dream();
    dream.summary = "Vivamus sed dapibus nibh. Integer sed arcu arcu, a sagittis nulla. Integer tortor eros, luctus vitae eleifend ultrices, dignissim non est. Sed volutpat varius metus nec tempor. Mauris at dui sit amet massa blandit suscipit. Aenean tempus leo ut dui sollicitudin quis rhoncus diam tincidunt. In ac suscipit quam. Pellentesque ut ornare nulla. Morbi accumsan hendrerit lectus ac ullamcorper.";
    dream.save();
  }

  function selectAll () {
    DreamPeer.doSelect(new Snake.Criteria(), function (dreams) {
      console.log(dreams);
    });
  }

  function selectWhere () {
    var c = new Snake.Criteria();
    c.add(DreamPeer.ID, 1);
    DreamPeer.doSelect(c, function (dream) {
      console.log(dream);
    });
  }

  function selectJoin () {
    var c = new Snake.Criteria();
    c.addJoin(DreamPeer.ID, DreamSearchPeer.DREAM_ID); // TODO test INNER_JOIN and RIGHT_JOIN
    DreamPeer.doSelect(c, function (dreams) {
      console.log(dreams);
    });
  }

  // TODO test selecting from a table with a foreign reference...
  // test loading a foreign object into object

  function update () {
    DreamPeer.doSelect(new Snake.Criteria(), function (dreams) {
      console.log(dreams);
      dreams[0].title = "Dream #5";
      dreams[0].save();
    });
  }

  Snake.ready(function () {
    //insert();
    //selectJoin();
    //loadViaLoop();
    performSearches();
  });
</script>
