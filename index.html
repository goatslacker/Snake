<script type="text/javascript" src="prototype.js"></script>
<script type="text/javascript" src="snake.js"></script>
<script type="text/javascript" src="stemmer.js"></script>
<script type="text/javascript" src="dreamcatcher.js"></script>

<script type="text/javascript">

  function doTestSearch (str) {
    var words = str.split(" ")
      , stemmed_words = []
      , i = 0
      , query = "",
      q = [];
    
    for (i = 0; i < words.length; i = i + 1) {
      stemmed_words.push(stemmer(words[i]));
      q.push("?");
    }

    query = "SELECT dream_id, COUNT(*) AS nb, SUM(weight) AS total_weight FROM dream_search, dream WHERE dream_id = dream.id AND word IN (#{words}) GROUP BY dream_id ORDER BY nb DESC, total_weight DESC".interpolate({ words: q });

    Snake.query(query, stemmed_words, (function (transaction, results) {
      console.log(transaction);
      console.log(results);
    }).bind(this));
  }

  function updateSearchIndex (dream) {
    dream = dream || new Dream();

    dream.title = dream.title || "";
    dream.summary = dream.summary || "";

    // get keywords and push them into an array repeated by weight...
    var summary = dream.summary.split(" ")
      , title = dream.title.split(" ")
      , tags = dream.tags
      , keywords = []
      , stop = [
        'i', 'im', 'ive', 'me', 'my', 'myself', 'we', 'weve', 'our', 'ours', 'ourselves', 'you', 'your', 
        'youre', 'youve', 'yours', 'yourself', 'yourselves', 'he', 'hes', 'hay', 'hey', 'him', 'his', 'himself', 'she', 
        'her', 'hers', 'herself', 'it', 'its', 'itself', 'they', 'them', 'their', 'theirs', 'themselves',
        'can', 'cent', 'what', 'which', 'who', 'whom', 'this', 'that', 'these', 'those', 'am', 'is', 'are',
        'was', 'take', 'aint', 'were', 'be', 'been', 'being', 'have', 'has', 'had', 'having', 'do', 'does',
        'did', 'cause', 'doing', 'a', 'an', 'the', 'and', 'but', 'if', 'or', 'because', 'as', 'until',
        'while', 'of', 'hi', 'at', 'by', 'for', 'with', 'about', 'against', 'between', 'into', 'makes',
        'through', 'during', 'before', 'after', 'above', 'below', 'to', 'from', 'up', 'down', 'else',
        'in', 'out', 'on', 'off', 'over', 'under', 'again', 'further', 'then', 'once', 'here', 'ago',
        'there', 'when', 'where', 'why', 'how', 'all', 'any', 'both', 'each', 'few', 'more',
        'most', 'other', 'some', 'such', 'no', 'nor', 'not', 'only', 'own', 'same', 'so',
        'than', 'too', 'very', 'put', 'also', 'other', 'gave', 'well', 'know', 'make', 'seen',
        'let', ''
      ]                                                             // TODO add more stop words
      , no_push = false
      , keys = []
      , keyword = null
      , index = {}
      , i = 0
      , j = 0
      , n = []
      , c = null;

    // delete existing keywords
    c = new Snake.Criteria();
    c.add(DreamSearchPeer.DREAM_ID, dream.id);
    DreamSearchPeer.doDelete(c);

    // remove stop words

    // then remove all the stop words
    // and remove all special chars, stem the words

    for (i = 0; i < summary.length; i = i + 1) {
      keyword = summary[i].replace(/[^a-zA-Z 0-9]+/g,'');

      for (j = 0; j < stop.length; j = j + 1) {
        if (stop[j] === keyword.toLowerCase()) {
          no_push = true;
        }
      }

      if (!no_push) {
        n.push(keyword);
      }

      no_push = false;
    }

    keywords = title.concat(title, title, n, tags, tags, tags)

    for (i = 0; i < keywords.length; i = i + 1) {

      // remove special chars, stem and push into keys
      var no_special_chars = keywords[i].replace(/[^a-zA-Z 0-9]+/g,'')
        , stemmed = stemmer(no_special_chars);

      index[stemmed] = no_special_chars;
      keys.push(stemmed);
    }

    keys.sort();

    keywords = {};

    // add up the weights

    for (i = 0; i < keys.length; i = i + 1) {
      if (i > 0 && keys[i] === keys[i - 1]) {
        keywords[keys[i]]++;
      } else {
        keywords[keys[i]] = 1;
      }
    }

    // add to database!
    for (i in keywords) {
      if (keywords.hasOwnProperty(i)) {
        var ds = new DreamSearch();
        ds.dream_id = dream.id;
        ds.word = index[i]; 
        ds.stem = i;
        ds.weight = keywords[i];
        ds.save();
      }
    }
  }


  function loadViaLoop () {
    var dreams = [
      {
        title: "Time in school",
        dream: "I never spend much time in school but I taught ladies plenty. It's true I hire my body out for pay, hey hey. I've gotten burned over Cheryl Tiegs, blown up for Raquel Welch. But when I end up in the hay it's only hay, hey hey. I might jump an open drawbridge, or Tarzan from a vine. 'Cause I'm the unknown stuntman that makes Eastwood look so fine.",
        date_format: "09-09-09",
        timestamp: 1293581218811,
        tags: ['school', 'vine', 'Eastwood', 'Tarzan', 'ladies']
      },
      {
        title: 'My "job"',
        dream: "This is my boss, Jonathan Hart, a self-made millionaire, he's quite a guy. This is Mrs H., she's gorgeous, she's one lady who knows how to take care of herself. By the way, my name is Max. I take care of both of them, which ain't easy, 'cause when they met it was MURDER!",
        date_format: "07-07-07",
        timestamp: null,
        tags: ['boss,guy,gorgeous,lady,max']
      },
      {
        title: "The Who", // TODO make sure the title doesn't get filtered by stop words
        dream: "Ten years ago a crack commando unit was sent to prison by a military court for a crime they didn't commit. These men promptly escaped from a maximum security stockade to the Los Angeles underground. Today, still wanted by the government, they survive as soldiers of fortune. If you have a problem and no one else can help, and if you can find them, maybe you can hire the A-team.",
        date_format: "10-10-10",
        timestamp: null,
        tags: ['crack,', 'commando,', 'unit,', 'prison,', 'escaped', 'two words']
      },
    ];

    var dream = null;

    for (var i = 0; i < dreams.length; i = i + 1) {
      dream = new Dream();
      dream.title = dreams[i].title;
      dream.summary = dreams[i].dream;
      dream.dream_date = dreams[i].date_format;
      dream.created_at = dreams[i].timestamp;

      dream.save((function (i, model) {
        if (dreams[i].tags.length > 0) {

          var tags = [];

          for (var j = 0; j < dreams[i].tags.length; j = j + 1) {
            var tag = new DreamTag();
            tag.dream_id = model.id;
            tag.tag = dreams[i].tags[j].replace(/[^a-zA-Z 0-9]+/g,'');
            tag.normalized = tag.tag.toLowerCase().split(" ").join("-");

            tag.save();
            tags.push(tag.tag);
          }

          model.tags = tags;
        }

        updateSearchIndex(model); 
      }).bind(this, i));
    }

  }

  function insert () {
    var dream = new Dream();
    dream.summary = "Vivamus sed dapibus nibh. Integer sed arcu arcu, a sagittis nulla. Integer tortor eros, luctus vitae eleifend ultrices, dignissim non est. Sed volutpat varius metus nec tempor. Mauris at dui sit amet massa blandit suscipit. Aenean tempus leo ut dui sollicitudin quis rhoncus diam tincidunt. In ac suscipit quam. Pellentesque ut ornare nulla. Morbi accumsan hendrerit lectus ac ullamcorper.";
    dream.save();
  }

  function selectAll () {
    DreamPeer.doSelect(new Snake.Criteria(), function (dreams) {
      console.log(dreams);
    });
  }

  function selectWhere () {
    var c = new Snake.Criteria();
    c.add(DreamPeer.ID, 1);
    DreamPeer.doSelect(c, function (dream) {
      console.log(dream);
    });
  }

  function selectJoin () {
    var c = new Snake.Criteria();
    c.addJoin(DreamPeer.ID, DreamSearchPeer.DREAM_ID); // TODO test INNER_JOIN and RIGHT_JOIN
    DreamPeer.doSelect(c, function (dreams) {
      console.log(dreams);
    });
  }

  // TODO test selecting from a table with a foreign reference...
  // test loading a foreign object into object

  function update () {
    DreamPeer.doSelect(new Snake.Criteria(), function (dreams) {
      console.log(dreams);
      dreams[0].title = "Dream #5";
      dreams[0].save();
    });
  }

  Snake.ready(function () {
    //insert();
    //selectJoin();
    //loadViaLoop();
    doTestSearch("The Who");
  });
</script>
