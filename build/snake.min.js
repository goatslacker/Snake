/**
  * Snake - A JavaScript ORM/DBAL
  *
  * @author <a href="mailto:josh@goatslacker.com">Josh Perez</a>
  * @version 0.1.4
  *//**
  * The Snake ORM/DBAL
  *
  * @namespace Snake
  * @this {Snake}
  */var Snake={version:"0.1.4",build:"alpha",global:this,debug:!1,config:{},log:function(a){"console"in Snake.global&&console.log(a)},interpolate:function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a=a.replace(new RegExp("#{"+c+"}","g"),typeof b[c][1]=="f"?b[c]():b[c]));return a},loadFromJSON:function(a,b){var c=null,d=null,e=null,f=null,g=null;for(c in a)if(a.hasOwnProperty(c)){g=a[c],g.jsName=c,g.columns.id={type:"INTEGER"},g.columns.created_at={type:"TIME"},g.map=[];for(d in a[c].columns)a[c].columns.hasOwnProperty(d)&&(e=a[c].columns[d],"foreign"in e&&(g.foreign||(g.foreign={}),f=e.foreign.split("."),g.foreign[f[0]]=[d,f[1]]),g.map.push(d));Snake.venom[a[c].tableName]=new Snake.venomousObject(g),Snake.global[c]=new Snake.base(g)}b&&b()},is_array:function(a){return Object.prototype.toString.call(a)==="[object Array]"}};Snake.define=function(a){var b=Snake;b.config.database=a},Snake.base=function(a){var b=null,c=null;c=function(){for(var b in a.columns)a.columns.hasOwnProperty(b)&&(this[b]=null)},c.allocate=function(a){var b=new c,d=null;b.old={};for(d in a)a.hasOwnProperty(d)&&(b[d]=a[d],b.old[d]=a[d]);return b},c.is=function(a){for(var b in a)a.hasOwnProperty(b)&&(this.prototype[b]=a[b])},b={save:function(b,c,d){var e=this,f=[],g=Snake.interpolate,h=[],i=0,j=0,k=null,l="";if(this.id){for(i=0,j=a.columns.length;i<j;i=i+1)this[a.columns[i]]!==this.old[a.columns[i]]&&(k=this[a.columns[i]]||null,f.push(k),h.push(a.columns[i]+" = ?"));l=g("UPDATE #{table} SET #{conditions} WHERE id = #{id}",{table:a.tableName,conditions:h,id:this.id})}else{for(i=0,j=a.map.length;i<j;i=i+1)k=this[a.map[i]]||null,a.map[i]==="created_at"&&k===null&&(k=Date.now()),f.push(k),h.push("?");l=g("INSERT INTO '#{table}' (#{columns}) VALUES (#{q})",{table:a.tableName,columns:a.map,q:h})}d===!0?b&&b(l,f):Snake.query(l,f,function(a,c){e.id=c.insertId,b&&b(e)},c)},doDelete:function(b,c,d){Snake.venom[a.tableName].find(this.id).doDelete(b,c,d)}},c.is(b),c.prototype.$super=b;return c},Snake.query=function(){function c(b,c){var d=Snake,e=d.config.database;b=b||function(){},c=c||function(){},a=openDatabase(e.name,e.version,e.displayName,e.size),a?b():c("Could not open database")}var a=null,b=null;b=function(b,d,e,f){var g=Snake;d=d||null,e=e||function(a,b){g.log(a),g.log(b)},f=f||function(a,b){g.log(a),g.log(b)},a?a.transaction(function(a){var c=null,h=0,i=0;g.is_array(b)||(b=[b]);for(h,i=b.length;h<i;h=h+1)c=b[h]+";",g.debug&&(g.log(c),d&&g.log(d)),a.executeSql(c,d,e,f)}):(g.log("Connecting to the database"),c(function(){Snake.query(b,d,e,f)}))};return b}(),Snake.venomousObject=function(a){var b={},c={},d=null,e=null,f=null;f=function(){c.sql={select:[],from:a.tableName,joins:[],where:{criterion:[],params:[]},orderBy:[],limit:!1}},e=function(){var d=arguments[0],e=arguments[1],f=arguments[2]||b.EQUAL,g=[],h=0,i=0;d in a.columns&&(d=a.tableName+"."+d);switch(f){case b.ISNULL:case b.ISNOTNULL:c.sql.where.criterion.push(d+" "+f);break;case b.IN:case b.NOTIN:for(h=0,i=e.length;h<i;h=h+1)g.push("?");c.sql.where.criterion.push(d+" "+f+" ("+g.join(", ")+")");break;default:c.sql.where.criterion.push(d+" "+f+" ?")}e&&(Snake.is_array(e)?c.sql.where.params=c.sql.where.params.concat(e):c.sql.where.params.push(e))},d=function(b,d,e,g,h){var i=null,j=Snake.interpolate;e=e||{},e.from=a.tableName,c.sql.joins.length>0&&(d=d+" "+c.sql.joins.join(" ")),c.sql.where.criterion.length>0&&(d=d+" WHERE #{where}",e.where=c.sql.where.criterion.join(" AND "),i=c.sql.where.params),c.sql.orderBy.length>0&&(d=d+" ORDER BY #{orderBy}",e.orderBy=c.sql.orderBy),c.sql.limit&&(c.sql.offset?(d=d+" LIMIT #{offset}, #{limit}",e.offset=c.sql.offset):d=d+" LIMIT #{limit}",e.limit=c.sql.limit),b?Snake.query(j(d,e),i,g,h):g&&g(j(d,e),i),f()},b={EQUAL:"=",NOT_EQUAL:"<>",GREATER_THAN:">",LESS_THAN:"<",GREATER_EQUAL:">=",LESS_EQUAL:"<=",ISNULL:"IS NULL",ISNOTNULL:"IS NOT NULL",LIKE:"LIKE",NOTLIKE:"NOT LIKE",IN:"IN",NOTIN:"NOT IN",LEFT_JOIN:"LEFT JOIN"},c={select:function(){for(var b=0,c=arguments.length;b<c;b=b+1)arguments[b]in a.columns&&this.sql.select.push(a.tableName+"."+arguments[b]);return this},find:function(){var a=null,c=null,d=null,f=null;if(arguments.length>1)a=arguments[0],c=arguments[1],c in b?d=b[c]:d=b[arguments[2]]||b.EQUAL,e(a,c,d);else if(typeof arguments[0]=="number")e("id",arguments[0]);else for(a in arguments[0])if(arguments[0].hasOwnProperty(a)){c=arguments[0][a];switch(Object.prototype.toString.call(c)){case"[object Array]":d=b.IN,e(a,c,d);break;case"[object RegExp]":d=b.LIKE,f=c.toString(),c=f,f=c.replace(/\W/g,""),c.substr(1,1)==="^"?c=f+"%":c.substr(-2,1)==="$"?c="%"+f:c="%"+f+"%",e(a,c,d);break;case"[object Object]":for(f in c)c.hasOwnProperty(f)&&(d=b[f]||b.EQUAL,e(a,c[f],d));break;default:d=b.EQUAL,e(a,c,d)}}return this},orderBy:function(b){var c=null,d="";for(c in b)b.hasOwnProperty(c)&&(d=b[c].toUpperCase(),c in a.columns&&(c=a.tableName+"."+c),this.sql.orderBy.push(c+" "+d));return this},join:function(c,d,e){var f=Snake.interpolate;e=b[e]||b.LEFT_JOIN,d?this.sql.joins.push(f("#{join_method} #{foreign_table} ON #{table}.#{primary_key} = #{foreign_table}.#{foreign_key}",{join_method:e,foreign_table:c,table:a.tableName,primary_key:d[0],foreign_key:d[1]})):"foreign"in a&&c in a.foreign&&this.sql.joins.push(f("#{join_method} #{foreign_table} ON #{table}.#{primary_key} = #{foreign_table}.#{foreign_key}",{join_method:e,foreign_table:c,table:a.tableName,primary_key:a.foreign[c][0],foreign_key:a.foreign[c][1]}));return this},offset:function(a){this.sql.offset=a;return this},limit:function(a){this.sql.limit=a;return this},retrieveByPK:function(a,b,c,d){this.find(a).doSelectOne(b,c,d)},doSelectOne:function(a,b,c){var d=null;c===!0?d=a:d=function(b){a&&(b.length>0?a(b[0]):a(null))},this.limit(1).doSelect(d,b,c)},doCount:function(a,b,c,e){c=c&&this.sql.select.length>0?"DISTINCT ":"";var f="SELECT COUNT("+c+"#{select}) AS count FROM #{from}",g=null,h={};this.sql.select.length===0?h.select="*":h.select=this.sql.select,e===!0?g=a:g=function(b,c){var d=c.rows.item(0);a&&a(d.count)},d(!e,f,h,g,b)},doDelete:function(a,b,c){d(!c,"DELETE FROM #{from}",null,a,b)},doSelect:function(b,c,e){var f="SELECT #{select} FROM #{from}",g=null,h={};this.sql.select.length===0?h.select="*":h.select=this.sql.select,e===!0?g=b:g=function(c,d){var e=[],f=0,g=0,h=null,i=d.rows;if(i.length>0)for(f=0,g=i.length;f<g;f=f+1)h=Snake.global[a.jsName].allocate(i.item(f)),e.push(h);b&&b(e)},d(!e,f,h,g,c)}},f();return c},Snake.venom={};var venom=Snake.venom,vql=venom